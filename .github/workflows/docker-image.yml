name: test-gitlab-sync

on:
  workflow_dispatch:

jobs:
  sync-to-gitlab:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # 拉取完整历史

      - name: Set Git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"

      - name: Set repo info
        id: repo-info
        run: |
          echo "owner=$(echo ${{ github.repository }} | cut -d'/' -f1)" >> $GITHUB_OUTPUT
          echo "repo=$(echo ${{ github.repository }} | cut -d'/' -f2)" >> $GITHUB_OUTPUT

      - name: Sync to GitLab (极狐香港站)
        env:
          GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
          OWNER: ${{ steps.repo-info.outputs.owner }}
          REPO: ${{ steps.repo-info.outputs.repo }}
        run: |
          git remote add gitlab "https://oauth2:${GITLAB_TOKEN}@gitlab.hk/${OWNER}/${REPO}.git" || true
          git pull --rebase gitlab main || true
          git push gitlab main
          echo "✅ Synced to GitLab (gitlab.hk)"
